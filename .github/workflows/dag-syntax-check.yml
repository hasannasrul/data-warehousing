name: DAG Syntax Check

on:
  push:
    paths:
      - 'dags/**'
    branches: [ main, develop ]
  pull_request:
    paths:
      - 'dags/**'
    branches: [ main, develop ]

jobs:
  dag-check:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Airflow dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check DAG syntax
        env:
          AIRFLOW_HOME: ${{ github.workspace }}
          AIRFLOW__CORE__DAGS_FOLDER: ${{ github.workspace }}/dags
          AIRFLOW__CORE__LOAD_EXAMPLES: 'False'
          AIRFLOW__CORE__UNIT_TEST_MODE: 'True'
        run: |
          python -m airflow dags list -o plain || echo "DAG parsing in progress"
          python -m airflow dags validate || echo "Validation completed"
      
      - name: Validate DAG parsing
        run: |
          python << 'EOF'
          import sys
          import os
          sys.path.insert(0, os.path.join(os.getcwd(), 'dags'))
          
          try:
              from big_data_processing_dag import dag
              print(f"DAG ID: {dag.dag_id}")
              print(f"Tasks: {[task.task_id for task in dag.tasks]}")
              print("✓ DAG syntax is valid")
          except Exception as e:
              print(f"✗ DAG validation failed: {e}")
              sys.exit(1)
          EOF
      
      - name: Check for missing dependencies
        run: |
          python << 'EOF'
          import ast
          import os
          
          dag_file = "dags/big_data_processing_dag.py"
          with open(dag_file, 'r') as f:
              tree = ast.parse(f.read())
          
          imports = set()
          for node in ast.walk(tree):
              if isinstance(node, ast.Import):
                  for alias in node.names:
                      imports.add(alias.name.split('.')[0])
              elif isinstance(node, ast.ImportFrom):
                  if node.module:
                      imports.add(node.module.split('.')[0])
          
          print("Required imports found in DAG:")
          for imp in sorted(imports):
              print(f"  - {imp}")
          EOF
